name: go-cfgw hourly updater

on:
  schedule:
  # run at start of each hour
  - cron: '0 * * * *'
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      # Optional values (set these as repository secrets or variables if you want to customize)
      BLOCKLIST_URLS: ${{ secrets.BLOCKLIST_URLS }}
      ALLOWLIST_URLS: ${{ secrets.ALLOWLIST_URLS }}
      DRY_RUN: ${{ secrets.DRY_RUN }}
      BLOCK_PAGE_ENABLED: ${{ secrets.BLOCK_PAGE_ENABLED }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
    - name: Build
      run: |
        go mod tidy
        go build -o go-cfgw ./cmd/go-cfgw
    - name: Validate required secrets
      run: |
        set -e
        if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
          echo "Required secrets CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID are not set."
          echo "Add them to repository secrets: Settings → Secrets and variables → Actions."
          exit 1
        fi
    - name: Run updater
      run: |
        ./go-cfgw
